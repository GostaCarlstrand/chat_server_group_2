{% extends "base-template.html" %}

{% block title %}
    Mailbox for {{ current_user.name }}
{% endblock %}

{% block content %}
    <h1 id="main-heading">Mailbox</h1>

    <p>Upload private key</p>
    <input type="file" id="priv-file" enctype="multipart/form-data" />
    <button onclick="readPrivateKey()">Submit private key</button><span id="priv-loaded"></span>


{% endblock %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
    <script src="/static/js/rsa.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
    let privateKey;





    function readPrivateKey() {
        let files = document.getElementById("priv-file").files;
        let file = files[0];
        let reader = new FileReader();

        reader.onloadend = function (event) {
            privateKey = event.target.result;
            privateKey = privateKey.replace(/(\r\n|\n|\r)/gm, "");
            getMsgFromServer(); //Retrieve all encrypted messages

        };

        reader.readAsText(file);
    }

    function createRowElement(text, tag) {
        const title = document.createElement(tag);
        title.innerText = text;
        document.body.appendChild(title);
    }

    function decryptMessage(encryptedMessages, size) {

        createRowElement("", 'hr')
        for(let i = 0; i < size; i++) {
            let decrypted_aes_key = rsaDecryptAesKey((encryptedMessages[i].encrypted_aes_key), privateKey);
            let decrypted_title = decryptData(encryptedMessages[i].title, decrypted_aes_key);
            let decrypted_body = decryptData(encryptedMessages[i].body, decrypted_aes_key);

            createRowElement(decrypted_title, 'td')
            createRowElement("", 'br')
            createRowElement(decrypted_body, 'td')
            createRowElement("", 'br')
            createRowElement("", 'hr')




        }
    }

    function decryptData(encrypted_message, key) {
        let clearText = CryptoJS.AES.decrypt(encrypted_message, key);
        return clearText.toString(CryptoJS.enc.Utf8);
    }


    function getMsgFromServer() {

        const xhttp = new XMLHttpRequest();
        xhttp.onload = function () {
            let encryptedMessages = JSON.parse(this.responseText);
            //encryptedMessages = JSON.stringify(encryptedMessages)
            let size = Object.keys(encryptedMessages).length;
            decryptMessage(encryptedMessages, size)
        }


        xhttp.open('GET', "http://127.0.0.1:5000/messages")
        xhttp.send()
    }


    function rsaDecryptAesKey(aes_key, private_rsa_key) {
            let rsaEncrypt = new JSEncrypt();

            rsaEncrypt.setPrivateKey(private_rsa_key);

            decryptedAESKey = rsaEncrypt.decrypt(aes_key);
            return decryptedAESKey
        }

        //- Importera privata nyckeln   X
        //-  Loopa igenom listan
        // - dekryptera AES nyckel med privata nyckeln
        // - dektryptera meddelande med aes nyckel

    </script>
{% endblock %}